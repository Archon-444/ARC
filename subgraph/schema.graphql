type User @entity {
  id: ID! # wallet address
  nftsOwned: [Token!]! @derivedFrom(field: "owner")
  listings: [Listing!]! @derivedFrom(field: "seller")
  bids: [Bid!]! @derivedFrom(field: "bidder")
  offers: [Offer!]! @derivedFrom(field: "maker")
  sales: [Listing!]! @derivedFrom(field: "buyer")
  totalSpent: BigInt!
  totalEarned: BigInt!
  xp: BigInt! # Gamification XP
  badges: [UserBadge!]! @derivedFrom(field: "user")
  joinedAt: BigInt!
  lastActive: BigInt!
}

type Badge @entity {
  id: ID! # badge_id from frontend (e.g., "early_adopter")
  name: String!
  description: String!
  icon: String!
  users: [UserBadge!]! @derivedFrom(field: "badge")
}

type UserBadge @entity {
  id: ID! # user.id + badge.id
  user: User!
  badge: Badge!
  unlockedAt: BigInt!
}

type Collection @entity {
  id: ID! # Contract address
  name: String
  symbol: String
  totalSupply: BigInt
  tokens: [Token!]! @derivedFrom(field: "collection")
  floorPrice: BigInt
  totalVolume: BigInt!
}

type Token @entity {
  id: ID! # ContractAddress-TokenID
  collection: Collection!
  tokenId: BigInt!
  owner: User!
  uri: String
  activeListing: Listing
  activeAuction: Auction
  transfers: [Transfer!]! @derivedFrom(field: "token")
}

type Listing @entity {
  id: ID!
  seller: User!
  token: Token!
  price: BigInt!
  createdAtTimestamp: BigInt!
  soldAtTimestamp: BigInt
  buyer: User
  status: ListingStatus!
}

enum ListingStatus {
  ACTIVE
  SOLD
  CANCELLED
}

type Auction @entity {
  id: ID!
  seller: User!
  token: Token!
  startingPrice: BigInt!
  duration: BigInt!
  endTime: BigInt!
  highestBid: BigInt
  highestBidder: User
  status: AuctionStatus!
  bids: [Bid!]! @derivedFrom(field: "auction")
}

enum AuctionStatus {
  ACTIVE
  ENDED
  CANCELLED
}

type Bid @entity {
  id: ID!
  auction: Auction!
  bidder: User!
  amount: BigInt!
  timestamp: BigInt!
}

type Offer @entity {
  id: ID!
  maker: User!
  taker: User # Nullable if collection offer
  token: Token # Nullable if collection offer
  collection: Collection!
  price: BigInt!
  expiration: BigInt!
  status: OfferStatus!
  signature: String!
}

enum OfferStatus {
  ACTIVE
  ACCEPTED
  CANCELLED
  EXPIRED
}

type Transfer @entity {
  id: ID!
  token: Token!
  from: User!
  to: User!
  timestamp: BigInt!
  transactionHash: String!
}
